<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= mode === 'edit' ? 'Edit Product' : 'Add New Product' %></title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
    />
    <style>
      .image-preview img {
        width: 60px;
        height: 60px;
        object-fit: cover;
        margin-right: 5px;
        border-radius: 4px;
      }
      .variation-box {
        border: 1px solid #ccc;
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 8px;
        position: relative;
      }
      .remove-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        background: transparent;
        border: none;
        color: red;
        font-size: 1.2rem;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <%- include('../partials/sidebar') %>

        <div class="col-md-10 p-4">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h4>
              <%= mode === 'edit' ? 'Edit Product' : 'Add New Product' %>
            </h4>
            <div><%= name %> <i class="fa-solid fa-user ms-2"></i></div>
          </div>

          <form
            id="productForm"
            action="<%= mode === 'edit' && product ? ('/admin/products/edit/' + product._id) : '/admin/products/add' %>"
            method="POST"
            enctype="multipart/form-data"
          >
            <p class="text-muted">
              <%= mode === 'edit' ? 'Edit the product details below' : 'Fill in the product details to add a new shoe to your inventory' %>
            </p>

            <div class="row mb-3">
              <div class="col-md-6">
                <label>Product Name</label>
                <input
                  type="text"
                  name="name"
                  class="form-control"
                  placeholder="Enter product name"
                  value="<%= product ? product.name : '' %>"
                  required
                />
              </div>
              <div class="col-md-6">
                <label>Product SKU</label>
                <input
                  type="text"
                  name="sku"
                  class="form-control"
                  placeholder="SKU-001"
                  value="<%= product ? product.product_sku : '' %>"
                  required
                  <%= mode === 'edit' ? 'readonly' : '' %>
                />
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <label>Price ($)</label>
                <input
                  type="number"
                  name="price"
                  step="0.01"
                  class="form-control"
                  value="<%= product ? product.price : '' %>"
                  required
                />
              </div>
              <div class="col-md-6">
                <label>Discount (%)</label>
                <input
                  type="number"
                  name="discount"
                  step="0.01"
                  class="form-control"
                  value="<%= product ? product.discount_percentage : '' %>"
                />
              </div>
            </div>

            <div class="mb-3">
              <label>Product Description</label>
              <textarea
                name="description"
                class="form-control"
                rows="3"
                placeholder="Enter detailed product description..."
                required
              ><%= product ? product.description : '' %></textarea>
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <label>Category</label>
                <select name="category" class="form-select" required>
                  <option value="">Select Category</option>
                  <% categories.forEach(category => { %>
                  <option value="<%= category.category %>" <%= product && product.product_category === category.category ? 'selected' : '' %>>
                    <%= category.category %>
                  </option>
                  <% }) %>
                </select>
              </div>
              <div class="col-md-6">
                <label>Shoe Type</label>
                <select name="type" class="form-select" required>
                  <option value="">Select Type</option>
                  <% types.forEach(type => { %>
                  <option value="<%= type.type %>" <%= product && product.product_type === type.type ? 'selected' : '' %>><%= type.type %></option>
                  <% }) %>
                </select>
              </div>
            </div>

            <div class="mb-4">
              <label>Product Variations</label>
              <div id="variationsContainer"></div>
              <button
                type="button"
                class="btn btn-outline-primary mt-2"
                onclick="addVariation()"
              >
                + Add Variation
              </button>
            </div>

            <div class="d-flex justify-content-end gap-2">
              <a href="/admin/products?limit=5&skip=0" class="btn btn-outline-secondary"
                >Cancel</a
              >
              <button type="submit" class="btn btn-dark"><%= mode === 'edit' ? 'Update Product' : 'Add Product' %></button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      let variationIndex = 0;
      const variationFiles = {}; // Track files by variation

      function addVariation(data = {}) {
        const index = data.index ?? variationIndex;
        const container = document.createElement("div");
        container.className = "variation-box";
        container.dataset.index = index;

        container.innerHTML = `
      <span class="remove-btn" onclick="this.parentElement.remove()">&times;</span>
      <div class="row g-3 align-items-end">
        <div class="col-md-3">
          <label>Size</label>
          <select name="variations[${index}][size]" class="form-select" required>
            <option value="">Select</option>
            <% sizes.forEach(size => { %>
              <option value="<%= size.size %>" ${data.size === "<%= size.size %>" ? 'selected' : ''}><%= size.size %></option>
            <% }) %>
          </select>
        </div>
        <div class="col-md-3">
          <label>Color</label>
          <select name="variations[${index}][color]" class="form-select" required>
            <option value="">Select</option>
            <% colors.forEach(color => { %>
              <option value="<%= color.color %>" ${data.color === "<%= color.color %>" ? 'selected' : ''}><%= color.color %></option>
            <% }) %>
          </select>
        </div>
        <div class="col-md-2">
          <label>Stock Quantity</label>
          <input type="number" name="variations[${index}][stock]" class="form-control" min="0" value="${data.stock ?? ''}" required />
        </div>
        <div class="col-md-4">
          <label>Images</label>
          <button type="button" class="btn btn-outline-secondary w-100" onclick="triggerImageUpload(this)">+ Add Image</button>
          <input type="file" accept="image/*" style="display:none" multiple />
          <div class="image-preview mt-2">
            ${(data.images || []).map(url => `<img src="${url}" />`).join('')}
          </div>
        </div>
      </div>
    `;

        const fileInput = container.querySelector('input[type="file"]');
        const previewBox = container.querySelector(".image-preview");
        variationFiles[index] = [];

        fileInput.addEventListener("change", function () {
          const files = Array.from(this.files);
          variationFiles[index].push(...files);

          previewBox.innerHTML = "";
          variationFiles[index].forEach((file) => {
            const reader = new FileReader();
            reader.onload = (e) => {
              const img = document.createElement("img");
              img.src = e.target.result;
              previewBox.appendChild(img);
            };
            reader.readAsDataURL(file);
          });
        });

        document.getElementById("variationsContainer").appendChild(container);
        variationIndex = Math.max(variationIndex, index + 1);
      }

      function triggerImageUpload(button) {
        const input = button.nextElementSibling;
        input.click();
      }

      document
        .getElementById("productForm")
        .addEventListener("submit", function (e) {
          const formData = new FormData(this);

          Object.entries(variationFiles).forEach(([index, files]) => {
            files.forEach((file) => {
              formData.append(`variationImages_${index}`, file);
            });
          });

          fetch(this.action, {
            method: this.method,
            body: formData,
          }).then((res) => {
            if (res.ok) {
              window.location = "/admin/products";
            } else {
              alert("Product submission failed");
            }
          });

          e.preventDefault();
        });

      // If in edit mode, pre-populate variations
      <% if (mode === 'edit' && product && product.variations && product.variations.length) { %>
        const editVariations = <%- JSON.stringify(product.variations) %>;
        window.onload = function() {
          editVariations.forEach(function(v, i) {
            addVariation({
              index: i,
              size: v.size,
              color: v.color,
              stock: v.stock,
              images: v.images || []
            });
          });
        };
      <% } %>
    </script>
  </body>
</html>
