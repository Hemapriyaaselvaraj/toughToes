<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Order Details</title>

  <!-- CSS -->
  <link rel="stylesheet" href="/css/orderDetail.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
  <div class="admin-layout">
    <%- include('../partials/sidebar') %>

    <div class="main-content">
      <%- include('../partials/navbar', { pageTitle: 'Order Detail', name: name }) %>

      <div class="container py-3">
        <h2 class="mb-4">Order #<%= order.orderId %></h2>

        <!-- Order Summary -->
        <div class="mb-4">
          <p><strong>Status:</strong> <%= order.status %></p>
          <p><strong>Date:</strong> <%= new Date(order.createdAt).toLocaleDateString() %></p>
          <p><strong>Total:</strong> Rs. <%= order.total %></p>
          <a href="/admin/orders/<%= order._id %>/invoice" class="btn btn-outline-primary btn-sm">Download Invoice</a>
        </div>

        <!-- Products -->
        <h5>Products</h5>
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>Product</th>
              <th>Quantity</th>
              <th>Price</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <% order.products.forEach(p => { %>
              <tr>
                <td><%= p.name %></td>
                <td><%= p.quantity %></td>
                <td>Rs. <%= p.price %></td>
                <td>
                  <% if (order.status === 'Placed' || order.status === 'Processing') { %>
                    <button class="btn btn-danger btn-sm" onclick="openCancelModal('<%= p._id %>')">Cancel</button>
                  <% } else if (order.status === 'Delivered') { %>
                    <button class="btn btn-warning btn-sm" onclick="openReturnModal('<%= p._id %>')">Return</button>
                  <% } %>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>

        <!-- Cancel full order -->
        <% if (order.status === 'Placed' || order.status === 'Processing') { %>
          <button class="btn btn-danger mt-3" onclick="openCancelModal('full')">Cancel Full Order</button>
        <% } %>

        <!-- Modals -->
        <!-- Cancel Modal -->
        <div class="modal fade" id="cancelModal" tabindex="-1">
          <div class="modal-dialog">
            <form class="modal-content" action="/admin/orders/<%= order._id %>/cancel" method="POST">
              <div class="modal-header">
                <h5 class="modal-title">Cancel Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <input type="hidden" name="productId" id="cancelProductId">
                <label for="cancelReason">Reason (optional)</label>
                <textarea class="form-control" name="reason" id="cancelReason"></textarea>
              </div>
              <div class="modal-footer">
                <button type="submit" class="btn btn-danger">Submit</button>
              </div>
            </form>
          </div>
        </div>

        <!-- Return Modal -->
        <div class="modal fade" id="returnModal" tabindex="-1">
          <div class="modal-dialog">
            <form class="modal-content" action="/admin/orders/<%= order._id %>/return" method="POST">
              <div class="modal-header">
                <h5 class="modal-title">Return Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <input type="hidden" name="productId" id="returnProductId">
                <label for="returnReason">Reason <span class="text-danger">*</span></label>
                <textarea class="form-control" name="reason" id="returnReason" required></textarea>
              </div>
              <div class="modal-footer">
                <button type="submit" class="btn btn-warning">Submit</button>
              </div>
            </form>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    function openCancelModal(productId) {
      document.getElementById('cancelProductId').value = productId;
      new bootstrap.Modal(document.getElementById('cancelModal')).show();
    }
    function openReturnModal(productId) {
      document.getElementById('returnProductId').value = productId;
      new bootstrap.Modal(document.getElementById('returnModal')).show();
    }
  </script>
</body>
</html>
