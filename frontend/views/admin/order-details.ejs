<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Order Details</title>

  <!-- CSS -->
  <link rel="stylesheet" href="/css/orderDetail.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
  <div class="admin-layout">
    <%- include('../partials/sidebar') %>

    <div class="main-content">
      <%- include('../partials/navbar', { pageTitle: 'Order Detail', name: name }) %>

      <div class="container py-3">
        <h2 class="mb-4">Order #<%= order.order_number %></h2>

        <!-- Order Summary -->
        <div class="mb-4">
          <p><strong>Status:</strong> <%= order.status %></p>
          <p><strong>Date:</strong> <%= new Date(order.createdAt).toLocaleDateString() %></p>
          <p><strong>Total:</strong> ₹ <%= order.total %></p>
        </div>

        <!-- Change Order Status -->
        <form action="/admin/orders/<%= order._id %>/status" method="POST" class="mb-4">
          <label for="status" class="me-2"><strong>Change Status:</strong></label>
          <select name="status" class="form-select d-inline w-auto" onchange="this.form.submit()">
            <option value="ORDERED" <%= order.status === 'ORDERED' ? 'selected' : '' %>>Ordered</option>
            <option value="SHIPPED" <%= order.status === 'SHIPPED' ? 'selected' : '' %>>Shipped</option>
            <option value="OUT_FOR_DELIVERY" <%= order.status === 'OUT_FOR_DELIVERY' ? 'selected' : '' %>>Out for Delivery</option>
            <option value="DELIVERED" <%= order.status === 'DELIVERED' ? 'selected' : '' %>>Delivered</option>
            <option value="RETURNED" <%= order.status === 'RETURNED' ? 'selected' : '' %>>Returned</option>
            <option value="CANCELLED" <%= order.status === 'CANCELLED' ? 'selected' : '' %>>Cancelled</option>
          </select>
        </form>

        <!-- Products Table -->
        <h5>Products</h5>
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>Product</th>
              <th>Quantity</th>
              <th>Price</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% order.products.forEach(p => { %>
              <tr>
                <td><%= p.name %></td>
                <td><%= p.quantity %></td>
                <td>₹ <%= p.price %></td>
                <td>
                  <% if (p.status === 'RETURN_REQUESTED') { %>
                    <span class="badge bg-warning">Return Requested</span>
                  <% } else if (p.status === 'RETURNED') { %>
                    <span class="badge bg-info">Returned</span>
                  <% } else { %>
                    <span class="badge bg-<%= p.status === 'DELIVERED' ? 'success' : 'primary' %>">
                      <%= p.status %>
                    </span>
                  <% } %>
                </td>
                <td>
                  <% if (p.status === 'RETURN_REQUESTED' || p.status === 'RETURNED' || (p.return_details && p.return_details.status === 'REJECTED')) { %>
                    <div class="d-flex gap-2">
                      <button type="button" class="btn btn-sm btn-info" 
                              data-bs-toggle="popover" 
                              data-bs-title="Return Request Details"
                              data-bs-content="Reason: <%= p.return_details.reason %><br>Comments: <%= p.return_details.comments || 'No comments' %><br>Requested on: <%= new Date(p.return_details.requested_at).toLocaleDateString() %><br>Refund Amount: ₹<%= p.return_details.refundAmount %><br>Status: <%= p.return_details.status %>">
                        <i class="fas fa-info-circle"></i>
                      </button>
                      <% if (p.status === 'RETURN_REQUESTED') { %>
                        <form method="POST" action="/admin/orders/<%= order._id %>/return/verify" class="d-flex gap-2">
                          <input type="hidden" name="productId" value="<%= p._id %>">
                          <button class="btn btn-success btn-sm" name="action" value="approve" title="Approve Return">
                            <i class="fas fa-check"></i>
                          </button>
                          <button class="btn btn-danger btn-sm" name="action" value="reject" title="Reject Return">
                            <i class="fas fa-times"></i>
                          </button>
                        </form>
                      <% } else if (p.status === 'RETURNED') { %>
                        <span class="badge bg-success">Approved & Refunded</span>
                      <% } else if (p.return_details.status === 'REJECTED') { %>
                        <span class="badge bg-danger">Return Rejected</span>
                      <% } %>
                    </div>
                  <% } %>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>

        <!-- Modals -->
        <!-- Cancel Modal -->
        <div class="modal fade" id="cancelModal" tabindex="-1">
          <div class="modal-dialog">
            <form class="modal-content" action="/admin/orders/<%= order._id %>/cancel" method="POST">
              <div class="modal-header">
                <h5 class="modal-title">Cancel Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <input type="hidden" name="productId" id="cancelProductId">
                <label for="cancelReason">Reason (optional)</label>
                <textarea class="form-control" name="reason" id="cancelReason"></textarea>
              </div>
              <div class="modal-footer">
                <button type="submit" class="btn btn-danger">Submit</button>
              </div>
            </form>
          </div>
        </div>

        <!-- Return Modal -->
        <div class="modal fade" id="returnModal" tabindex="-1">
          <div class="modal-dialog">
            <form class="modal-content" action="/admin/orders/<%= order._id %>/return" method="POST">
              <div class="modal-header">
                <h5 class="modal-title">Return Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <input type="hidden" name="productId" id="returnProductId">
                <label for="returnReason">Reason <span class="text-danger">*</span></label>
                <textarea class="form-control" name="reason" id="returnReason" required></textarea>
              </div>
              <div class="modal-footer">
                <button type="submit" class="btn btn-warning">Submit</button>
              </div>
            </form>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function openCancelModal(productId) {
      document.getElementById('cancelProductId').value = productId;
      new bootstrap.Modal(document.getElementById('cancelModal')).show();
    }

    function openReturnModal(productId) {
      document.getElementById('returnProductId').value = productId;
      new bootstrap.Modal(document.getElementById('returnModal')).show();
    }

    // Initialize all popovers
    document.addEventListener('DOMContentLoaded', function() {
      const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]');
      const popoverList = [...popoverTriggerList].map(popoverTriggerEl => new bootstrap.Popover(popoverTriggerEl, {
        html: true,
        placement: 'left'
      }));
    });
  </script>
</body>
</html>
