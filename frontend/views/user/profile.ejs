<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Account - ToughToes</title>
  <link rel="stylesheet" href="/css/profile.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom px-4">
    <a class="navbar-brand fw-bold" href="#">ToughToes</a>
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav mx-auto">
        <li class="nav-item"><a class="nav-link" href="#">Men</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Women</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Kids</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Sale</a></li>
      </ul>
      <form class="d-flex">
        <input class="form-control me-2" type="search" placeholder="Search shoes..." />
        <button class="btn btn-outline-secondary" type="submit"><i class="fas fa-search"></i></button>
      </form>
      <div class="ms-4 d-flex align-items-center">
        <i class="fas fa-user me-3"></i>
        <i class="fas fa-heart me-3"></i>
        <i class="fas fa-shopping-cart me-3"></i>
        <span><%= user.firstName %> <%= user.lastName %></span>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container my-5 d-flex">
    <!-- Sidebar -->
    <div class="sidebar p-3 me-4 border rounded">
      <ul class="list-unstyled">
        <li><a href="#" class="active"><i class="fas fa-user me-2"></i>Profile</a></li>
        <li><a href="#"><i class="fas fa-box me-2"></i>Orders</a></li>
        <li><a href="#"><i class="fas fa-heart me-2"></i>Wishlist</a></li>
        <li><a href="#"><i class="fas fa-map-marker-alt me-2"></i>Addresses</a></li>
        <li><a href="#"><i class="fas fa-wallet me-2"></i>My Wallet</a></li>
        <li>
          <form id="logoutForm" method="POST" action="/user/logout" style="display:inline;">
            <button type="submit" class="btn btn-link p-0" style="color:inherit;text-decoration:none;">
              <i class="fas fa-sign-out-alt me-2"></i>Logout
            </button>
          </form>
        </li>
      </ul>
<script>
  // Redirect to home after logout
  const logoutForm = document.getElementById('logoutForm');
  if (logoutForm) {
    logoutForm.addEventListener('submit', function(e) {
      e.preventDefault();
      fetch('/user/logout', { method: 'POST', credentials: 'same-origin' })
        .then(() => { window.location.href = '/'; });
    });
  }
</script>
    </div>

    <!-- Profile Content -->
    <div class="flex-grow-1">
      <div class="profile-box border rounded p-4 mb-4">
        <h4><%= user.firstName %> <%= user.lastName %></h4>
        <p class="text-muted"><%= user.email %><br>
          Member since <%= user.createdAt ? new Date(user.createdAt).toLocaleString('default', { month: 'long', year: 'numeric' }) : '' %>
        </p>
        <hr>
        <h6 class="mb-3">Personal Info</h6>
        <form method="POST" action="/profile" id="profileForm">
          <div class="row mb-3">
            <div class="col">
              <label>First Name</label>
              <input type="text" class="form-control" name="firstName" value="<%= user.firstName %>" disabled>
            </div>
            <div class="col">
              <label>Last Name</label>
              <input type="text" class="form-control" name="lastName" value="<%= user.lastName %>" disabled>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col">
              <label>Email Address</label>
              <div class="input-group">
                <input type="email" class="form-control" name="email" id="emailInput" value="<%= user.email %>" disabled>
                <button type="button" class="btn btn-outline-secondary" id="editEmailBtn">Edit</button>
              </div>
            </div>
            <div class="col">
              <label>Phone Number</label>
              <input type="text" class="form-control" name="phoneNumber" value="<%= user.phoneNumber %>" disabled>
            </div>
          </div>
          <div id="profileEditBtns" style="display:none;">
            <button class="btn btn-dark" type="submit"><i class="fas fa-save me-2"></i>Save Changes</button>
            <button class="btn btn-link text-muted" type="button" id="cancelEditBtn">Cancel</button>
          </div>
        </form>
        <button class="btn btn-outline-dark mt-2" id="editProfileBtn" type="button"><i class="fas fa-edit me-2"></i>Edit</button>
        <script>
          const editBtn = document.getElementById('editProfileBtn');
          const cancelBtn = document.getElementById('cancelEditBtn');
          const form = document.getElementById('profileForm');
          const editBtns = document.getElementById('profileEditBtns');
          const firstNameInput = form.elements['firstName'];
          const lastNameInput = form.elements['lastName'];
          const phoneInput = form.elements['phoneNumber'];
          const emailInput = document.getElementById('emailInput');
          const editEmailBtn = document.getElementById('editEmailBtn');

          editBtn.onclick = function() {
            firstNameInput.disabled = false;
            lastNameInput.disabled = false;
            phoneInput.disabled = false;
            editBtns.style.display = '';
            editBtn.style.display = 'none';
          };
          if(cancelBtn) {
            cancelBtn.onclick = function() {
              firstNameInput.value = '<%= user.firstName %>';
              lastNameInput.value = '<%= user.lastName %>';
              phoneInput.value = '<%= user.phoneNumber %>';
              firstNameInput.disabled = true;
              lastNameInput.disabled = true;
              phoneInput.disabled = true;
              emailInput.value = '<%= user.email %>';
              emailInput.disabled = true;
              editEmailBtn.style.display = '';
              editBtns.style.display = 'none';
              editBtn.style.display = '';
            };
          }

          // Email edit logic
          editEmailBtn.onclick = function() {
            emailInput.disabled = false;
            emailInput.focus();
            editEmailBtn.style.display = 'none';
            editBtns.style.display = '';
          };

          form.onsubmit = function(e) {
            firstNameInput.disabled = false;
            lastNameInput.disabled = false;
            phoneInput.disabled = false;
            // If email is being changed, start OTP flow
            if (!emailInput.disabled && emailInput.value !== '<%= user.email %>') {
              e.preventDefault();
              fetch('/user/request-email-otp', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ newEmail: emailInput.value })
              })
              .then(res => res.json())
              .then(data => {
                if (data.success) {
                  window.location.href = '/user/verifyotp?email=' + encodeURIComponent(emailInput.value);
                } else {
                  alert(data.message || 'Could not send OTP.');
                }
              });
            }
          };
        </script>
      </div>

      <!-- Change Password Section -->
      <div class="border rounded p-4 mb-4 bg-light">
        <h6>Change Password</h6>
        <p class="text-muted small">Change your account password securely.</p>
        <button class="btn btn-outline-dark" id="changePasswordBtn">Change Password</button>
      </div>

      <!-- Danger Zone -->
      <div class="danger-zone border rounded p-4 bg-light">
        <h6>Danger Zone</h6>
        <p class="text-muted small">These actions cannot be undone. Please proceed with caution.</p>
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <strong>Deactivate Account</strong>
            <p class="text-muted mb-0 small">Deactivating account will temporarily disable your login. Reach out to customer care to Re-Activate</p>
          </div>
          <button class="btn btn-outline-dark">Deactivate Account</button>
        </div>
      </div>
</div>

<!-- Change Password Modal -->
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="changePasswordModalLabel">Change Password</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="changePasswordForm">
          <div class="mb-3">
            <label for="changePasswordEmail" class="form-label">Email</label>
            <input type="email" class="form-control" id="changePasswordEmail" value="<%= user.email %>" readonly>
          </div>
          <div class="mb-3">
            <button type="button" class="btn btn-outline-secondary" id="sendOtpBtn">Send OTP</button>
          </div>
          <div class="mb-3">
            <label for="otpInput" class="form-label">OTP</label>
            <input type="text" class="form-control" id="otpInput" placeholder="Enter OTP" disabled>
          </div>
          <div class="mb-3">
            <label for="newPasswordInput" class="form-label">New Password</label>
            <input type="password" class="form-control" id="newPasswordInput" placeholder="New Password" disabled>
          </div>
          <div class="mb-3">
            <label for="confirmPasswordInput" class="form-label">Confirm Password</label>
            <input type="password" class="form-control" id="confirmPasswordInput" placeholder="Confirm Password" disabled>
          </div>
          <button type="submit" class="btn btn-dark" id="submitChangePasswordBtn" disabled>Change Password</button>
        </form>
        <div id="changePasswordError" class="text-danger mt-2"></div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Change Password Modal logic
  const changePasswordBtn = document.getElementById('changePasswordBtn');
  const changePasswordModal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
  const sendOtpBtn = document.getElementById('sendOtpBtn');
  const otpInput = document.getElementById('otpInput');
  const newPasswordInput = document.getElementById('newPasswordInput');
  const confirmPasswordInput = document.getElementById('confirmPasswordInput');
  const submitChangePasswordBtn = document.getElementById('submitChangePasswordBtn');
  const changePasswordError = document.getElementById('changePasswordError');

  changePasswordBtn.onclick = function() {
    changePasswordModal.show();
    otpInput.value = '';
    newPasswordInput.value = '';
    confirmPasswordInput.value = '';
    otpInput.disabled = true;
    newPasswordInput.disabled = true;
    confirmPasswordInput.disabled = true;
    submitChangePasswordBtn.disabled = true;
    changePasswordError.textContent = '';
  };

  sendOtpBtn.onclick = function() {
    fetch('/user/login/sendOtp', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email: document.getElementById('changePasswordEmail').value })
    })
    .then(res => res.text())
    .then(() => {
      otpInput.disabled = false;
      changePasswordError.textContent = 'OTP sent to your email.';
    })
    .catch(() => {
      changePasswordError.textContent = 'Failed to send OTP.';
    });
  };

  otpInput.oninput = function() {
    if (otpInput.value.length === 6) {
      newPasswordInput.disabled = false;
      confirmPasswordInput.disabled = false;
      submitChangePasswordBtn.disabled = false;
    } else {
      newPasswordInput.disabled = true;
      confirmPasswordInput.disabled = true;
      submitChangePasswordBtn.disabled = true;
    }
  };

  document.getElementById('changePasswordForm').onsubmit = function(e) {
    e.preventDefault();
    fetch('/user/changePassword', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: document.getElementById('changePasswordEmail').value,
        otp: otpInput.value,
        password: newPasswordInput.value,
        confirmPassword: confirmPasswordInput.value
      })
    })
    .then(res => res.text())
    .then(response => {
      const trimmed = response.trim();
      if (trimmed === 'Password changed successfully!') {
        changePasswordModal.hide();
        alert('Password changed successfully!');
      } else if (trimmed.includes('Invalid otp')) {
        changePasswordError.textContent = 'Wrong OTP';
      } else {
        changePasswordError.textContent = trimmed;
      }
    })
    .catch(() => {
      changePasswordError.textContent = 'Failed to change password.';
    });
  };
</script>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg-dark text-white py-4 mt-5">
    <div class="container d-flex justify-content-between flex-wrap">
      <div>
        <h5>ToughToes</h5>
        <p>Premium shoes for every step of your journey.</p>
      </div>
      <div>
        <h6>Quick Links</h6>
        <ul class="list-unstyled">
          <li><a href="#" class="text-white">About Us</a></li>
          <li><a href="#" class="text-white">Contact</a></li>
          <li><a href="#" class="text-white">Size Guide</a></li>
          <li><a href="#" class="text-white">Returns</a></li>
        </ul>
      </div>
      <div>
        <h6>Categories</h6>
        <ul class="list-unstyled">
          <li><a href="#" class="text-white">Men's Shoes</a></li>
          <li><a href="#" class="text-white">Women's Shoes</a></li>
          <li><a href="#" class="text-white">Kids' Shoes</a></li>
          <li><a href="#" class="text-white">Sale</a></li>
        </ul>
      </div>
      <div>
        <h6>Follow Us</h6>
        <a href="#" class="text-white me-2"><i class="fab fa-facebook"></i></a>
        <a href="#" class="text-white me-2"><i class="fab fa-instagram"></i></a>
        <a href="#" class="text-white"><i class="fab fa-twitter"></i></a>
      </div>
    </div>
    <div class="text-center mt-3">
      <small>© 2025 ToughToes. All rights reserved.</small>
    </div>
  </footer>

</body>
</html>
