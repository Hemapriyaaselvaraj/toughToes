<!DOCTYPE html>
<html lang="en">
<head>
  <style>
    #addressModal input,
    #addressModal select {
      pointer-events: auto !important;
      background: #fff !important;
      color: #212529 !important;
      opacity: 1 !important;
      border: 1px solid #ced4da !important;
      box-shadow: none !important;
    }
    #addressModal input[readonly],
    #addressModal input[disabled],
    #addressModal select[disabled] {
      pointer-events: auto !important;
      background: #fff !important;
      color: #212529 !important;
      opacity: 1 !important;
    }
  </style>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout - ToughToes</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">

  <!-- FontAwesome for icons (same as home.ejs) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Your global styles -->
  <link rel="stylesheet" href="/css/style.css">

  <!-- Your page-specific styles -->
  <link rel="stylesheet" href="/css/checkout.css">
  <link rel="stylesheet" href="/css/home.css">


</head>
<body>
  <%- include('../partials/user-navbar', { name: name }) %>



  <main class="checkout-page" style="display: flex; flex-wrap: wrap; gap: 2rem; align-items: flex-start;">
    <!-- Left: Address + Payment -->
    <div style="flex: 1 1 48%; min-width: 320px; max-width: 600px; display: flex; flex-direction: column; gap: 24px;">
      <!-- Address Section -->
      <section class="address-section" style="margin-bottom:0;">
        <h2>Select Delivery Address</h2>
        <div class="address-list">
          <% if (addresses.length === 0) { %>
            <p>No saved addresses found.</p>
          <% } else { %>
            <% addresses.forEach(address => { %>
              <div class="address-card <%= address.default ? 'default' : '' %>">
                <input
                  type="radio"
                  name="selectedAddress"
                  value="<%= address._id %>"
                  <%= address.isDefault ? 'checked' : '' %>
                >
                <div>
                  <p><strong><%= address.name %></strong> <span style="color:#888; font-size:0.97em; margin-left:8px;">[<%= address.label || '' %>]</span> <span style="color:#888; font-size:0.97em; margin-left:8px;">[<%= address.type || '' %>]</span></p>
                  <p style="margin-bottom:2px;"><%= address.house_number ? address.house_number + ', ' : '' %><%= address.locality ? address.locality + ', ' : '' %><%= address.street %></p>
                  <p style="margin-bottom:2px;">City: <%= address.city %></p>
                  <p style="margin-bottom:2px;">State: <%= address.state %></p>
                  <p style="margin-bottom:2px;">Pincode: <%= address.pincode %></p>
                  <p style="margin-bottom:2px;">Phone: <%= address.phone_number %></p>
                </div>
                <button class="edit-address" 
                  data-address-id="<%= address._id %>" 
                  data-address-name="<%= address.name %>" 
                  data-address-label="<%= address.label || '' %>"
                  data-address-type="<%= address.type || '' %>"
                  data-address-housenumber="<%= address.house_number || '' %>"
                  data-address-locality="<%= address.locality || '' %>"
                  data-address-street="<%= address.street %>"
                  data-address-city="<%= address.city %>"
                  data-address-state="<%= address.state %>"
                  data-address-pincode="<%= address.pincode %>"
                  data-address-phone="<%= address.phone_number %>"
                >Edit</button>
              </div>
            <% }) %>
          <% } %>
          <button class="add-address" id="openAddAddressModal">+ Add New Address</button>
        </div>
      </section>
      <!-- Payment Method Section (full width, below address) -->
      <section class="payment-method-section" style="background:#fff; border:1px solid #ddd; border-radius:8px; padding:24px; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
        <h2 style="font-size:1.4em; margin-bottom:18px;">Payment Method</h2>
        <div class="form-check" style="margin-bottom: 12px;">
          <input class="form-check-input" type="radio" name="paymentMethod" id="codOption" value="COD" checked>
          <label class="form-check-label" for="codOption">
            Cash on Delivery
          </label>
        </div>
      </section>
    </div>
    <!-- Right: Order Summary -->
    <section class="product-summary" style="flex: 1 1 48%; min-width: 320px; max-width: 600px;">
      <h2>Order Summary</h2>
      <% if (products.length === 0) { %>
        <p>Your cart is empty.</p>
      <% } else { %>
        <% products.forEach(product => { %>
          <div class="product-item d-flex align-items-center mb-3" style="border-bottom:1px solid #eee; padding-bottom:10px;">
            <img src="<%= product.image[0] || product.image %>" alt="<%= product.name %>" style="width:70px;height:70px;object-fit:cover;border-radius:8px;margin-right:15px;">
            <div class="flex-grow-1">
              <div style="font-weight:600;"><%= product.name %></div>
              <% if (product.size) { %><span style="font-size:13px;">Size: <%= product.size %></span><% } %>
              <% if (product.color) { %><span style="font-size:13px; margin-left:10px;">Color: <%= product.color %></span><% } %>
              <div style="font-size:13px; color:#888;">
                <span>Qty: <%= product.quantity %></span>
                <% if (product.discount > 0) { %>
                  <span style="margin-left:10px; text-decoration:line-through; color:#b0b0b0;">₹<%= product.priceBefore %></span>
                  <span style="margin-left:5px; color:#d9534f;">₹<%= Math.round(product.priceAfter) %> each</span>
                  <span style="margin-left:5px; color:#28a745; font-size:12px;">(<%= product.discount %>% OFF)</span>
                <% } else { %>
                  <span style="margin-left:10px;">₹<%= product.priceBefore %> each</span>
                <% } %>
              </div>
            </div>
            <div style="font-weight:600; min-width:90px; text-align:right;">₹<%= Math.round(product.quantity * product.priceAfter).toLocaleString('en-IN') %></div>
          </div>
        <% }) %>
      <% } %>
      <div class="price-breakdown">
        <div class="price-breakdown mt-3" style="background:#f8f9fa; border-radius:8px; padding:16px;">
          <div class="d-flex justify-content-between mb-1"><span>Subtotal</span><span>₹<%= subtotal.toLocaleString('en-IN', {minimumFractionDigits:2}) %></span></div>
          <div class="d-flex justify-content-between mb-1"><span>Tax (8 %)</span><span>₹<%= tax.toLocaleString('en-IN', {minimumFractionDigits:2}) %></span></div>
          <div class="d-flex justify-content-between mb-2"><span>Shipping</span><span>₹<%= shipping.toLocaleString('en-IN', {minimumFractionDigits:2}) %></span></div>
          <hr class="my-2">
          <div class="d-flex justify-content-between" style="font-size:1.2em;font-weight:600;"><span>Total</span><span>₹<%= total.toLocaleString('en-IN', {minimumFractionDigits:2}) %></span></div>
        </div>
      </div>
      <button id="placeOrder">Place Order</button>
    </section>
  <!-- Address Modal (shared for add/edit) -->
  <div id="addressModal" class="modal" style="display:none; position:fixed; z-index:2000; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.25); align-items:center; justify-content:center;">
    <div class="modal-dialog" style="background:#fff; border-radius:10px; max-width:420px; width:95vw; margin:auto; padding:32px 28px 24px 28px; position:relative; box-shadow:0 8px 32px rgba(0,0,0,0.18);">
      <button id="closeAddressModal" style="position:absolute; top:12px; right:16px; background:none; border:none; font-size:1.5em; color:#888; cursor:pointer;">&times;</button>
      <h3 id="addressModalTitle" style="margin-bottom:18px;">Add Address</h3>
      <form id="addressForm">
        <input type="hidden" name="addressId" id="addressId">
        <div class="mb-3">
          <label for="addressName" class="form-label">Name</label>
          <input type="text" class="form-control" id="addressName" name="name" required>
        </div>
        <div class="mb-3">
          <label for="addressLabel" class="form-label">Label</label>
          <input type="text" class="form-control" id="addressLabel" name="label">
        </div>
        <div class="mb-3">
          <label for="addressType" class="form-label">Type</label>
          <select class="form-control" id="addressType" name="type">
            <option value="Home">Home</option>
            <option value="Work">Work</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="addressHouseNumber" class="form-label">House Number</label>
          <input type="text" class="form-control" id="addressHouseNumber" name="house_number">
        </div>
        <div class="mb-3">
          <label for="addressLocality" class="form-label">Locality</label>
          <input type="text" class="form-control" id="addressLocality" name="locality">
        </div>
        <div class="mb-3">
          <label for="addressCity" class="form-label">City</label>
          <input type="text" class="form-control" id="addressCity" name="city" required>
        </div>
        <div class="mb-3">
          <label for="addressState" class="form-label">State</label>
          <input type="text" class="form-control" id="addressState" name="state" required>
        </div>
        <div class="mb-3">
          <label for="addressPincode" class="form-label">Pincode</label>
          <input type="text" class="form-control" id="addressPincode" name="pincode" required pattern="[0-9]{6}">
        </div>
        <div class="mb-3">
          <label for="addressPhone" class="form-label">Phone</label>
          <input type="text" class="form-control" id="addressPhone" name="phone_number" required pattern="[0-9]{10}">
        </div>
        <button type="submit" class="btn btn-dark w-100" id="saveAddressBtn">Save Address</button>
      </form>
    </div>
  </div>

  </main>

  <!-- Footer -->
  <footer class="bg-dark text-white py-4 mt-5">
    <div class="container d-flex justify-content-between flex-wrap">
      <div>
        <h5>ToughToes</h5>
        <p>Premium shoes for every step of your journey.</p>
      </div>
      <div>
        <h6>Quick Links</h6>
        <ul class="list-unstyled">
          <li><a href="#" class="text-white">About Us</a></li>
          <li><a href="#" class="text-white">Contact</a></li>
          <li><a href="#" class="text-white">Size Guide</a></li>
          <li><a href="#" class="text-white">Returns</a></li>
        </ul>
      </div>
      <div>
        <h6>Categories</h6>
        <ul class="list-unstyled">
          <li><a href="#" class="text-white">Men's Shoes</a></li>
          <li><a href="#" class="text-white">Women's Shoes</a></li>
          <li><a href="#" class="text-white">Kids' Shoes</a></li>
          <li><a href="#" class="text-white">Sale</a></li>
        </ul>
      </div>
      <div>
        <h6>Follow Us</h6>
        <a href="#" class="text-white me-2"><i class="fab fa-facebook"></i></a>
        <a href="#" class="text-white me-2"><i class="fab fa-instagram"></i></a>
        <a href="#" class="text-white"><i class="fab fa-twitter"></i></a>
      </div>
    </div>
    <div class="text-center mt-3">
      <small>© 2025 ToughToes. All rights reserved.</small>
    </div>
  </footer>
  <script>
    // Modal open/close logic
    const addressModal = document.getElementById('addressModal');
    const closeAddressModal = document.getElementById('closeAddressModal');
    const addressForm = document.getElementById('addressForm');
    const addressModalTitle = document.getElementById('addressModalTitle');
    const saveAddressBtn = document.getElementById('saveAddressBtn');
    // Open Add Address
    document.getElementById('openAddAddressModal').onclick = function() {
      addressModalTitle.textContent = 'Add Address';
      addressForm.reset();
      document.getElementById('addressId').value = '';
      addressModal.style.display = 'flex';
      // Set default type to Home
      document.getElementById('addressType').value = 'Home';
      // Ensure all fields are editable
      [
        'addressName', 'addressLabel', 'addressType', 'addressHouseNumber',
        'addressLocality', 'addressCity', 'addressState',
        'addressPincode', 'addressPhone'
      ].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.readOnly = false;
          el.disabled = false;
          el.removeAttribute('readonly');
          el.removeAttribute('disabled');
        }
      });
    };
    // Open Edit Address
    document.querySelectorAll('.edit-address').forEach(btn => {
      btn.onclick = function() {
        addressModalTitle.textContent = 'Edit Address';
        document.getElementById('addressId').value = btn.getAttribute('data-address-id');
        document.getElementById('addressName').value = btn.getAttribute('data-address-name') || '';
        document.getElementById('addressLabel').value = btn.getAttribute('data-address-label') || '';
        // Set addressType robustly
        const typeVal = btn.getAttribute('data-address-type');
        const allowedTypes = ['Home', 'Work', 'Other'];
        document.getElementById('addressType').value = allowedTypes.includes(typeVal) ? typeVal : 'Home';
        document.getElementById('addressHouseNumber').value = btn.getAttribute('data-address-housenumber') || '';
        document.getElementById('addressLocality').value = btn.getAttribute('data-address-locality') || '';
        document.getElementById('addressCity').value = btn.getAttribute('data-address-city') || '';
        document.getElementById('addressState').value = btn.getAttribute('data-address-state') || '';
        document.getElementById('addressPincode').value = btn.getAttribute('data-address-pincode') || '';
        document.getElementById('addressPhone').value = btn.getAttribute('data-address-phone') || '';
        // Ensure all fields are editable
        [
          'addressName', 'addressLabel', 'addressType', 'addressHouseNumber',
          'addressLocality', 'addressCity', 'addressState',
          'addressPincode', 'addressPhone'
        ].forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            el.readOnly = false;
            el.disabled = false;
            el.removeAttribute('readonly');
            el.removeAttribute('disabled');
          }
        });
        addressModal.style.display = 'flex';
      };
    });
    // Close modal
    closeAddressModal.onclick = function() {
      addressModal.style.display = 'none';
    };
    window.onclick = function(e) {
      if (e.target === addressModal) addressModal.style.display = 'none';
    };
    // Save address (add/edit)
    addressForm.onsubmit = function(e) {
      e.preventDefault();
      console.log('Address form submit handler called');
      const formData = new FormData(addressForm);
      const data = Object.fromEntries(formData.entries());
      console.log('Form data:', data);
      const url = data.addressId ? '/customer/address/edit' : '/customer/address/add';
      fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
      .then(res => res.json())
      .then(resp => {
        console.log('API response:', resp);
        if (resp.success) {
          addressModal.style.display = 'none';
          location.reload();
        } else {
          alert(resp.message || 'Failed to save address');
        }
      });
    };

    // Place order logic
    document.getElementById('placeOrder').addEventListener('click', () => {
      const selectedAddress = document.querySelector('input[name="selectedAddress"]:checked');
      if (!selectedAddress) return alert('Please select a delivery address.');
      fetch('/customer/checkout/place-order', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ addressId: selectedAddress.value })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          window.location.href = `/order-success?orderId=${data.orderId}`;
        } else {
          alert(data.message || 'Failed to place order');
        }
      });
    });
  </script>

  <!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
