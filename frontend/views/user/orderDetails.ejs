<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Details - ToughToes</title>
  <link rel="stylesheet" href="/css/profile.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
</head>
<body>
  <%- include('../partials/user-navbar', { name: user ? user.firstName + ' ' + user.lastName : '' }) %>

  <div class="container my-5">
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <a href="/order/my-orders" class="btn btn-outline-secondary btn-sm me-3">
                <i class="fas fa-arrow-left me-1"></i> Back to Orders
              </a>
              <h4 class="mb-0">Order #<%= order.orderNumber %></h4>
            </div>
            <div>
              <span class="badge bg-<%= order.status === 'DELIVERED' ? 'success' : (order.status === 'CANCELLED' ? 'danger' : 'primary') %>">
                <%= order.status %>
              </span>
              <% if (order.status === 'ORDERED') { %>
                <button class="btn btn-danger btn-sm ms-2" onclick="cancelOrder('<%= order._id %>')">
                  <i class="fas fa-times me-1"></i> Cancel Order
                </button>
              <% } %>
              <% if (order.status === 'DELIVERED') { %>
                <a href="/order/download-invoice/<%= order._id %>" class="btn btn-outline-dark btn-sm ms-2" target="_blank">
                  <i class="fas fa-download me-1"></i> Download Invoice
                </a>
              <% } %>
            </div>
          </div>
          <div class="card-body">
            <!-- Order Info -->
            <div class="row mb-4">
              <div class="col-md-6">
                <h5>Order Information</h5>
                <p class="mb-1"><strong>Order Date:</strong> <%= new Date(order.createdAt).toLocaleDateString() %></p>
                <p class="mb-1"><strong>Payment Method:</strong> <%= order.paymentMethod %></p>
                <p class="mb-1"><strong>Payment Status:</strong> <%= order.paymentStatus %></p>
                <% if (order.estimatedDelivery) { %>
                  <p class="mb-1"><strong>Estimated Delivery:</strong> <%= new Date(order.estimatedDelivery).toLocaleDateString() %></p>
                <% } %>
              </div>
              <div class="col-md-6">
                <h5>Shipping Address</h5>
                <p class="mb-1"><%= order.shippingAddress.name %></p>
                <p class="mb-1"><%= order.shippingAddress.house_number %>, <%= order.shippingAddress.street %></p>
                <p class="mb-1"><%= order.shippingAddress.locality %></p>
                <p class="mb-1"><%= order.shippingAddress.city %>, <%= order.shippingAddress.state %></p>
                <p class="mb-1">PIN: <%= order.shippingAddress.pincode %></p>
                <p class="mb-1">Phone: <%= order.shippingAddress.phone_number %></p>
              </div>
            </div>

            <!-- Order Items -->
            <h5>Order Items</h5>
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>Product</th>
                    <th>Price</th>
                    <th>Quantity</th>
                    <th>Total</th>
                    <th>Status</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <% order.items.forEach(function(item) { %>
                    <tr>
                      <td>
                        <div class="d-flex align-items-center">
                          <img src="<%= item.image %>" alt="<%= item.name %>" class="me-3" style="width: 60px; height: 60px; object-fit: cover;">
                          <div>
                            <h6 class="mb-0"><%= item.name %></h6>
                            <small>Size: <%= item.size %>, Color: <%= item.color %></small>
                          </div>
                        </div>
                      </td>
                      <td>₹<%= item.price %></td>
                      <td><%= item.quantity %></td>
                      <td>₹<%= item.price * item.quantity %></td>
                      <td>
                        <span class="badge bg-<%= item.status === 'RETURNED' ? 'warning' : 
                          (item.status === 'RETURN_REQUESTED' ? 'info' : 
                          (order.status === 'DELIVERED' ? 'success' : 'primary')) %>">
                          <%= item.status || order.status %>
                        </span>
                      </td>
                      <td>
                        <% if (item.status === 'RETURN_REQUESTED') { %>
                          <span class="text-muted">Return Pending Approval</span>
                        <% } else if (item.status === 'RETURNED') { %>
                          <span class="text-muted">Returned</span>
                        <% } else if (order.status === 'DELIVERED' || order.status === 'Delivered') { %>
                          <button class="btn btn-warning btn-sm" onclick="requestReturn('<%= order._id %>', '<%= item._id %>')">
                            Request Return
                          </button>
                        <% } %>
                      </td>
                    </tr>
                  <% }); %>
                </tbody>
              </table>
            </div>

            <!-- Order Summary -->
            <div class="row mt-4">
              <div class="col-md-6 ms-auto">
                <table class="table table-bordered">
                  <tbody>
                    <tr>
                      <td><strong>Subtotal</strong></td>
                      <td class="text-end">₹<%= order.subtotal %></td>
                    </tr>
                    <tr>
                      <td><strong>Shipping</strong></td>
                      <td class="text-end">₹<%= order.shipping_charge %></td>
                    </tr>
                    <tr>
                      <td><strong>Tax</strong></td>
                      <td class="text-end">₹<%= order.tax %></td>
                    </tr>
                    <tr>
                      <td><strong>Total</strong></td>
                      <td class="text-end"><strong>₹<%= order.total %></strong></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>
  <script>
    async function cancelOrder(orderId) {
      const result = await Swal.fire({
        title: 'Cancel Order',
        text: 'Are you sure you want to cancel this order?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, cancel it',
        cancelButtonText: 'No, keep it',
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d'
      });
      
      if (!result.isConfirmed) {
        return;
      }
      
      try {
        const response = await fetch(`/order/cancel/${orderId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        const data = await response.json();
        if (data.success) {
          await Swal.fire({
            title: 'Order Cancelled',
            text: 'Your order has been cancelled successfully',
            icon: 'success',
            confirmButtonColor: '#28a745'
          });
          window.location.reload();
        } else {
          await Swal.fire({
            title: 'Error',
            text: data.message || 'Failed to cancel order',
            icon: 'error',
            confirmButtonColor: '#dc3545'
          });
        }
      } catch (error) {
        await Swal.fire({
          title: 'Error',
          text: 'An error occurred while cancelling the order',
          icon: 'error',
          confirmButtonColor: '#dc3545'
        });
      }
    }

    async function requestReturn(orderId, itemId) {
      const { value: formValues } = await Swal.fire({
        title: 'Request Return',
        html: `
          <div class="mb-3">
            <label class="form-label">Return Reason</label>
            <select id="returnReason" class="form-select">
              <option value="">Select a reason</option>
              <option value="DAMAGED">Product damaged/defective</option>
              <option value="WRONG_ITEM">Wrong item received</option>
              <option value="SIZE_ISSUE">Size/fit issue</option>
              <option value="QUALITY_ISSUE">Quality not as expected</option>
              <option value="OTHER">Other reason</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Additional Comments</label>
            <textarea id="returnComments" class="form-control" rows="3" placeholder="Please provide more details about your return request"></textarea>
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Submit Return Request',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#ffc107',
        cancelButtonColor: '#6c757d',
        preConfirm: () => {
          const reason = document.getElementById('returnReason').value;
          const comments = document.getElementById('returnComments').value;
          
          if (!reason) {
            Swal.showValidationMessage('Please select a return reason');
            return false;
          }
          
          return { reason, comments };
        }
      });

      if (!formValues) {
        return;
      }

      try {
        const response = await fetch(`/order/return-request`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            orderId,
            itemId,
            reason: formValues.reason,
            comments: formValues.comments
          })
        });
        
        const data = await response.json();
        if (data.success) {
          await Swal.fire({
            title: 'Return Requested',
            text: 'Your return request has been submitted successfully',
            icon: 'success',
            confirmButtonColor: '#28a745'
          });
          window.location.reload();
        } else {
          await Swal.fire({
            title: 'Error',
            text: data.message || 'Failed to request return',
            icon: 'error',
            confirmButtonColor: '#dc3545'
          });
        }
      } catch (error) {
        await Swal.fire({
          title: 'Error',
          text: 'An error occurred while requesting the return',
          icon: 'error',
          confirmButtonColor: '#dc3545'
        });
      }
    }
  </script>
</body>
</html>
